\section{PESOS E RESTRIÇÕES}

Apesar a importância da resolução de conflitos, existem diversas outras nuances durante o planejamento das grades horárias que precisam ser levadas em conta para que as grades produzidas sejam aplicáveis na prática.

Para possibilitar a otimização simultêanea de várias características das grades, optou-se por utilizar um sistema de métricas, cada qual mensura quantitativamente determinada característica do horário, e contém um peso que define a sua importância para o horário como um todo. Com estas métricas, para obter o custo de determinada solução, ou seja, a representação da quantidade de problemas que apresenta, basta tomar a média ponderada das métricas. 

Adicionalmente, as métricas podem ser rígidas ou suaves. As métricas rígidas precisam ser perfeitamente atendidas para que a grade horária seja considerada viável, enquanto as métricas suaves promovem a melhoria da qualidade, mas não necessariamente precisam ser perfeitamente atendidas.

As próximas seções terão como objetivo explicar cada uma destas métricas e os desafios associados. A \autoref{subsec:salvamento} entrará em mais detalhes sobre como as grades horárias passaram a ser salvas após a implementação das métricas.

\subsection{Agrupamento de aulas}

Observando grades horárias escolares, é possível notar que existe um desejo de realizar agrupamentos, formando aulas duplas. Isso aumenta a produtividade das aulas, à medida que diminui a troca e deslocamento de professores entre as salas. Para produzir estes agrupamentos, foram adicionadas algumas métricas que fazem o otimizador penalizar:

\begin{enumerate}
	\item Aulas separadas;
	\item Aulas desagrupadas;
	\item Excessos de aulas iguais para determinada turma em um dia;
	\item Dias com todas aulas planejadas distintas para deteriminada turma;
\end{enumerate}

\begin{quadro}[!htb]
	\centering
	\caption{Exemplo de dia com aulas separadas.\label{qua:aulasSeparadas}}
	\begin{tabular}{|p{3cm}|p{3cm}|p{3cm}|}
		\hline
		\textbf{Aula} & \textbf{Professor} & \textbf{Matéria} \\
		\hline
		1 & Marcos & Matemática \\
		\hline
		2 & Fábio & Física \\
		\hline
		3 & Marcos & Matemática \\
		\hline
		4 & Luciana & Português \\
		\hline
		5 & Luciana & Português \\
		\hline
		6 & Luciana & Português \\
		\hline
	\end{tabular}
	\fonte{Autoria própria}
\end{quadro}

Observando o quadro \ref{qua:aulasSeparadas}, é possível notar a presença das situações comentadas:

\begin{itemize}
	\item Aulas separadas: 1, 2 e 3, visto que não estão em nenhum agrupamento;
	\item Aulas desagrupadas: 1 e 3, pois consistem em múltiplas aulas iguais, no mesmo dia, que não foram agrupadas;
	\item Excessos de aulas: 4, 5, 6, pois consiste em uma aula tripla, considerada anti-didática no Ensino Médio
\end{itemize}

Por fim, a situação de dias com todas aulas diferentes, que serão referidos como "Dias fragmentados" neste trabalho, pode ser observada no quadro \ref{qua:fragmentado}.

\begin{quadro}[!htb]
	\centering
	\caption{Exemplo de dia fragmentado.\label{qua:fragmentado}}
	\begin{tabular}{|p{3cm}|p{3cm}|p{3cm}|}
		\hline
		\textbf{Aula} & \textbf{Professor} & \textbf{Matéria} \\
		\hline
		1 & Marcos & Matemática \\
		\hline
		2 & Fábio & Física \\
		\hline
		3 & Luciana & Português \\
		\hline
		4 & Roberto & Geografia \\
		\hline
		5 & Renato & História \\
		\hline
	\end{tabular}
	\fonte{Autoria própria}
\end{quadro}

\subsection{Constantes}

Durante o desenvolvimento, concebeu-se o conceito de "Aulas constantes", como aulas que absolutamente devem ser alocadas em determinada posição da grade horária. Isto é útil para guiar o otimizador rumo a uma solução desejada, quando já são conhecidas algumas aulas que devem ser fixas. 

Como exemplo de caso de uso, uma escola com seis aulas diárias pode ter alguns dias da semana com menos aulas, e pode ser interessante definir explicitamente quais dias devem ter a última aula da grade horária não alocada (vazia). A figura \ref{fig:constantes} mostra um exemplo de configuração de aulas constantes para determinada grade horária.

\begin{figure}[!htb]
	\centering
	\caption{Aulas constantes}
	\includegraphics[width=1\textwidth]{./dados/figuras/constantes}
	\fonte{Autor}
	\label{fig:constantes}
\end{figure}
\pagebreak

Considerando a natureza absoluta das aulas constantes, estas não são consideradas um métrica de qualidade, e não possuem um peso próprio. Em vez disso, no método "GeraGradeInicial" do algoritmo \ref{alg:otimizadorInicial}, o otimizador já aloca as aulas constantes nas posições desejadas, e a função "EscolheHorariosAleatoriosValidos" não seleciona posições que estejam alocadas com aulas constantes.

\subsection{Restrições}

As restrições representam o oposto das aulas constantes: posições em que determinadas aulas não devem ser alocadas. Implementaram-se no otimizador restrições suaves e rígidas, cada uma podendo também receber um peso customizado. Dessa forma, é possível configurar o otimizador para nunca alocar determinada aula em certa posição da grade, ou simplesmente evitar isso.

Como exemplo de uso dessa funcionalidade, a figura \ref{fig:restricoes} demonstra uma configuração de restrições para determinado professor que não pode ser alocado nas duas últimas aulas de qualquer dia da grade horária.

\begin{figure}[!htb]
	\centering
	\caption{Restrições}
	\includegraphics[width=1\textwidth]{./dados/figuras/restricoes}
	\fonte{Autor}
	\label{fig:restricoes}
\end{figure}
\pagebreak

No caso das restrições, a métrica associada mensura a quantidade de restrições violadas, ou seja, posições em que determinada aula foi alocada, mas não deveria ter sido.

\subsection{Regiões}

O conceito de regiões foi concebido como uma forma de proporcionar ainda mais controle ao usuário, sobre o posicionamento das aulas na grade horária. As regiões consistem em um grupo arbitrário de posições da grade horária (uma região), associado a uma regra relacionada a uma quantidade de aulas. Com as regiões, é possível determinar mínimos, máximos ou quantidades exatas de aulas que devem ser alocadas em certas posições da grade horária.

Como exemplo de uso das regiões, a figura \ref{fig:regioes} demonstra uma configuração utilizada para assegurar que em todos os dias da grade horária, o professor tenha alguma aula alocada no primeiro horário.

\begin{figure}[!htb]
	\centering
	\caption{Exemplo de região}
	\includegraphics[width=1\textwidth]{./dados/figuras/regioes}
	\fonte{Autor}
	\label{fig:regioes}
\end{figure}
\pagebreak

A região configurada na \ref{fig:regioes} pode ser interpretada da seguinte forma: "Verônica" deve ter exatamente cinco aulas alocadas dentro das posições marcadas pela cor azul. Como o otimizador não permite conflitos, cada uma das cinco aulas deverá ser alocada em um dos diferentes dias, garantindo que "Verônica" terá uma aula agendada no primeiro horário de todos os dias.

Neste caso, a métrica associada mensura o erro das regiões, ou seja, a diferença entre a quantidade de aulas esperada de acordo com a regra de cada região e a quantidade real de aulas alocadas.

\subsection{Grupos de Alinhamento}

Os grupos de alinhamento representam uma forma de configurar o otimizador para agendar aulas para diferentes turmas, nos mesmos horários. Isto é útil para o conceito dos Itinrários Formativos do Novo Ensino Médio, como citado anteriormente.

Como exemplo de utilização dos grupos de alinhamentos, tem-se a configuração da figura \ref{fig:gruposAlinhamento}.

\begin{figure}[!htb]
	\centering
	\caption{Exemplo de grupo de alinhamento}
	\includegraphics[width=1\textwidth]{./dados/figuras/gruposAlinhamento}
	\fonte{Autor}
	\label{fig:gruposAlinhamento}
\end{figure}
\pagebreak

O efeito da configuração do grupo de alinhamento da figura \ref{fig:gruposAlinhamento}, pode ser observado na grade horária final gerada na figura \ref{fig:alinhados}, com as aulas corretamente alocadas em horários simultâneos.

\begin{figure}[!htb]
	\centering
	\caption{Efeito de grupo de alinhamento}
	\includegraphics[width=1\textwidth]{./dados/figuras/alinhados}
	\fonte{Autor}
	\label{fig:alinhados}
\end{figure}
\pagebreak

Implementaram-se duas métricas de qualidade relacionadas aos grupos de alinhamento, uma que mensura a quantidade de grupos, que deve ser minimizada; e outra que mede a quantidade de aulas "desalinhadas", ou seja, aulas que deveriam ser agendadas no mesmo horário, mas que não foram.

\subsection{Janelas}

As janelas consistem em situações em que um professor tem um horário sem aulas agendadas em sua jornada de trabalho, ficando ocioso na escola. O quadro \ref{qua:janelas} exemplifica esta situação.

\begin{quadro}[!htb]
	\centering
	\caption{Exemplo de dia com janela.\label{qua:janelas}}
	\begin{tabular}{|p{3cm}|p{3cm}|p{3cm}|p{3cm}|}
		\hline
		\textbf{Aula} & \textbf{6ºAno} & \textbf{7ºAno} & \textbf{8ºAno} \\
		\hline
		1 & Jéssica & Rosa & Adriana \\
		\hline
		2 & Jéssica & Rosa & Adriana \\
		\hline
		3 & Fábio & Jéssica & Rosa \\
		\hline
		4 & Adriana & Jéssica & Rosa \\
		\hline
		5 & Beatriz & Adriana & Jéssica \\
		\hline
	\end{tabular}
	\fonte{Autoria própria}
\end{quadro}

No quadro \ref{qua:janelas}, a professora Adriana tem uma janela na terceira aula, visto que tem aulas alocadas antes e depois (aulas 1, 2, 4 e 5). Em contrapartida, apesar de não ter nenhuma aula planejada no quinto horário, Rosa não tem janelas neste exemplo, pois pode encerrar seu expediente na quarta aula.

A métrica de janelas simplesmente mede, para cada professor, o número de horários na grade em que existem janelas.

\subsection{Preferências}

\subsection{Armazenamento de soluções}
\label{subsec:salvamento}

Com a adição das métricas, o critério para considerar uma grade horária como uma solução válida ficou mais estrito, e em muitos casos tornou-se impossível obter uma grade que atenda perfeitamente todas as nuances. Tendo isto em mente, foi necessário implementar uma funciondalide de armazenamento de grades horárias um pouco mais detalhada. O resultado disso, pode ser visto no algoritmo \ref{alg:otimizadorComRestricoes}.

\begin{algorithm}
	\caption{Otimizador com persistência de grades horárias}
	\label{alg:otimizadorComRestricoes}
	\KwIn{Lista de professores $LP$, lista de turmas $LT$, matriz de aulas por professor por turma $MA$, temperatura inicial $TI$, Taxa de resfriamento $TR$}
	\KwOut{Grade horária de professores otimizada}
	$temperatura \leftarrow TI$\\
	$grade \leftarrow$ CriaGradeInicial$(LP, LT, MA)$\\
	$iteracoesSemAlteracao \leftarrow 0$\\
	$solucoes \leftarrow$ lista vazia\\
	\While {condição de parada não atingida} {
		$deltaTotal \leftarrow 0$\\
		\For {$passo = 0$ até $numeroPassos$} {
			$turma \leftarrow grade.EscolheTurmaAleatoria()$\\
			$linhas \leftarrow grade.EscolheHorariosAleatoriosValidos(sala)$\\
			$delta \leftarrow grade.CalculaDelta(sala, linhas)$\\
			$probabilidade \leftarrow e^{-delta/temperatura}$\\
			$valorAceite \leftarrow Aleatorio(0, 1)$\\
			\If {$delta < 0$ ou $probabilidade \ge valorAceite$} {
				$grade.PermutaProfessores(sala, linha1, linha2)$\\
				$deltaTotal \leftarrow deltaTotal + delta$\\
				\If {grade não existe na lista de soluções} {
					insere grade na lista de soluções\\
					limita lista de soluções às 100 melhores grades\\
				}
			}
		}
		\eIf {$delta = 0$} {
			$iteracoesSemAlteracao \leftarrow iteracoesSemAlteracao + 1$\\
		}{
			$iteracoesSemAlteracao \leftarrow 0$\\
		}
		\If {$iteracoesSemAlteracao \ge 15$} {
			salvaGradesRelevantes()\\
			apaga lista de soluções\\
			$temperatura \leftarrow TI$\\
			$iteracoesSemAlteracao \leftarrow 0$\\
		}
		$temperatura \leftarrow temperatura * TR$
	}
\end{algorithm}
\pagebreak

Consinderando as diversas métricas de qualidade que as grades horárias passaram a ter, o método "salvaGradesRelevantes" do algoritmo \ref{alg:otimizadorComRestricoes} salva, para cada métrica escolhida, as 5 grades que tiveram a melhor pontuação em cada métrica. A princípio, optou-se por utilizar as métricas de qualidade geral, janelas, agrupamento de aulas e número de preferências resolvidas, mas este método pode ser expandido para qualquer uma das métricas implementadas no sistema.

